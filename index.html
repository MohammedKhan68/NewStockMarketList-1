<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>5% Rotation — Live Watchlist</title>
<style>
:root{
  --bg:#071018; --card:#0f1620; --muted:#9aa6b2; --text:#e6eef6;
  --accent:#2f81f7; --pos:#2dcc6f; --neg:#f85149;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071018 0,#04060a 100%);color:var(--text);padding:18px}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.title{display:flex;align-items:center;gap:12px}
.logo{background:var(--accent);padding:6px 10px;border-radius:8px;font-weight:700}
.hint{color:var(--muted);font-size:0.9rem}
.controls{display:flex;gap:10px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
.card{background:var(--card);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
@media(max-width:920px){.grid{grid-template-columns:1fr}.controls{flex-wrap:wrap}}
.top-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.status{color:var(--muted);font-size:0.9rem}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;min-width:1000px}
th,td{padding:10px 12px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px}
th:first-child,td:first-child{text-align:center}
th:nth-child(2),td:nth-child(2),th:nth-child(3),td:nth-child(3){text-align:left}
.ticker{font-family:ui-monospace,monospace}
.percent-pos{color:var(--pos)}
.percent-neg{color:var(--neg)}
.rank-badge{display:inline-block;width:40px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);font-weight:600}
.spark{width:90px;height:26px}
.side-card .big{font-size:1.1rem;font-weight:700}
.small-muted{color:var(--muted);font-size:0.85rem}
.input,select{width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.kv{display:flex;justify-content:space-between;margin-top:6px}
.footer{display:flex;justify-content:space-between;color:var(--muted);font-size:0.85rem;margin-top:12px}
.top-pick{display:flex;flex-direction:column;gap:8px}
.badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-size:0.86rem}
.note{color:var(--muted);font-size:0.82rem;margin-top:8px}
.manual-target-row{display:flex;gap:8px;margin-bottom:6px;align-items:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <div class="logo">5%</div>
      <div>
        <div style="font-weight:700;font-size:1.15rem">Rotation — Live Watchlist</div>
        <div class="hint">Live snapshot via your Render proxy</div>
      </div>
    </div>
    <div class="controls">
      <button id="refreshBtn" class="btn">Refresh now</button>
      <button id="themeToggle" class="btn">Toggle Light</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="top-row">
          <div><strong>Watchlist</strong></div>
          <div class="status" id="status">Idle</div>
        </div>
        <div class="small-muted">Non-bank, non-liquor, non-entertainment list. Edit tickers in CONFIG below if needed.</div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table id="watchTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Ticker</th>
                <th>Company</th>
                <th>Price ($)</th>
                <th>Change ($)</th>
                <th>Change %</th>
                <th>1M%</th>
                <th>3M%</th>
                <th>6M%</th>
                <th>Support%</th>
                <th>TargetUpside%</th>
                <th>Rank</th>
                <th>Spark</th>
                <th>Last Updated</th>
              </tr>
            </thead>
            <tbody id="stock-table-body"></tbody>
          </table>
        </div>
        <div class="note">If TargetUpside is blank, use Settings → Manual Price Targets to set a value.</div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">DCA & Exit Calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="small-muted">Portfolio ($)</label>
            <input id="inpPortfolio" class="input" type="number" value="1000">
            <label class="small-muted">Planned trade capital ($)</label>
            <input id="inpCapital" class="input" type="number" value="1000">
            <label class="small-muted">Entry price ($)</label>
            <input id="inpEntry" class="input" type="number" value="200">
          </div>
          <div>
            <label class="small-muted">Allocations (%)</label>
            <input id="inpAlloc" class="input" type="text" value="50,30,20">
            <div class="small-muted" style="margin-top:6px">Format: initial,DCA1,DCA2 (sum should equal 100)</div>
            <label class="small-muted">DCA trigger drops (%)</label>
            <input id="inpTriggers" class="input" type="text" value="4,8">
            <label class="small-muted">Slippage per share ($)</label>
            <input id="inpSlippage" class="input" type="number" value="0.0">
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="calcBtn" class="btn">Calculate</button>
          <button id="copyCalc" class="btn">Copy summary</button>
        </div>

        <div id="calcResults" style="margin-top:10px;color:var(--muted)"></div>
      </div>
    </div>

    <aside>
      <div class="card side-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Next Best Stock</strong><div class="small-muted">Best ranked candidate now</div></div>
          <div id="nextBadge" class="badge">—</div>
        </div>
        <div style="margin-top:12px">
          <div class="top-pick">
            <div class="big" id="nextSymbol">—</div>
            <div class="small-muted" id="nextReason">—</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div class="kv"><div class="small-muted">Score</div><div id="nextScore">-</div></div>
              <div class="kv"><div class="small-muted">Dip %</div><div id="nextDip">-</div></div>
              <div class="kv"><div class="small-muted">Upside</div><div id="nextUpside">-</div></div>
            </div>
          </div>
        </div>
        <div class="note">Click any row to autofill the DCA entry price.</div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:10px">Settings</div>
        <div class="small-muted">Proxy URL, request delay & ranking weights</div>

        <label class="small-muted" style="margin-top:8px">Proxy base URL</label>
        <input id="proxyInput" class="input" type="text" value="https://newstockmarketlist.onrender.com">

        <label class="small-muted" style="margin-top:8px">Request delay (ms)</label>
        <input id="delayInput" class="input" type="number" value="300">

        <label class="small-muted" style="margin-top:8px">Ranking weights (dip,support,target)</label>
        <input id="weightsInput" class="input" type="text" value="0.4,0.3,0.3">

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="saveSettings" class="btn">Save settings</button>
          <button id="resetBtn" class="btn">Reset table</button>
        </div>

        <div style="margin-top:10px" class="small-muted">Manual targets below will override server targets if server target is absent.</div>

        <div id="manualTargetsUI" style="margin-top:12px"></div>
      </div>
    </aside>
  </div>

  <div class="footer">
    <div>Tip: Use Render proxy for faster aggregated data.</div>
    <div class="small-muted">Made for rotation strategy</div>
  </div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const CONFIG = {
  PROXY_BASE: 'https://newstockmarketlist.onrender.com',
  TICKERS: [
    {symbol:"META", name:"Meta Platforms Inc"},
    {symbol:"AAPL", name:"Apple Inc"},
    {symbol:"MSFT", name:"Microsoft Corp"},
    {symbol:"GOOGL", name:"Alphabet Inc"},
    {symbol:"AMZN", name:"Amazon.com Inc"},
    {symbol:"NVDA", name:"NVIDIA Corp"},
    {symbol:"TSLA", name:"Tesla Inc"},
    {symbol:"CRM", name:"Salesforce Inc"},
    {symbol:"SHOP", name:"Shopify Inc"},
    {symbol:"ADBE", name:"Adobe Inc"}
  ],
  REQUEST_DELAY_MS: 300,
  WEIGHTS: [0.4,0.3,0.3]
};

/* ---------------- HELPERS ---------------- */
const $ = id => document.getElementById(id);
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
function fmt(n,d=2){ return (n===null||n===undefined||isNaN(n))? '-' : Number(n).toFixed(d) }
function pct(n,d=2){ return (n===null||n===undefined||isNaN(n))? '-' : (n>0?'+':'') + Number(n).toFixed(d) + '%' }

/* ---------------- UI BUILD ---------------- */
const tbody = $('stock-table-body');
const statusEl = $('status');
const nextSymbol = $('nextSymbol');
const nextReason = $('nextReason');
const nextScore = $('nextScore');
const nextDip = $('nextDip');
const nextUpside = $('nextUpside');
const nextBadge = $('nextBadge');

function clearTable(){ tbody.innerHTML=''; }
function createRow(idx, t){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${idx}</td>
    <td class="ticker">${t.symbol}</td>
    <td>${t.name}</td>
    <td>-</td>
    <td>-</td>
    <td>0.00%</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td><span class="rank-badge">-</span></td>
    <td><canvas class="spark"></canvas></td>
    <td>-</td>
  `;
  tr.addEventListener('click', ()=> {
    const priceCell = tr.children[3].textContent;
    if(priceCell && priceCell !== '...' && priceCell !== '-' && priceCell!=='ERR'){
      $('inpEntry').value = priceCell;
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
  });
  tbody.appendChild(tr);
  return tr;
}

/* ---------------- CALCULATIONS ---------------- */
function percentChangeFromHistory(closes, periods){
  if(!closes || closes.length===0) return null;
  const n = closes.length;
  const idx = Math.max(0, n-1-periods);
  const past = closes[idx].close;
  const now = closes[n-1].close;
  return ((now - past)/past)*100;
}
function supportProximity(closes, lookbackDays=30){
  if(!closes || closes.length===0) return null;
  const n = closes.length;
  const recent = closes.slice(Math.max(0, n - lookbackDays));
  let low = Math.min(...recent.map(c=>c.close));
  const now = closes[n-1].close;
  return ((now - low)/low)*100;
}
function sparklineDraw(canvas, closes){
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth;
  const h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!closes || closes.length<2) return;
  const vals = closes.slice(-7).map(c=>c.close);
  const min = Math.min(...vals), max = Math.max(...vals);
  const range = max - min || 1;
  ctx.lineWidth = 1.6;
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const x = (i/(vals.length-1)) * (w-2) + 1;
    const y = h - ((v - min)/range) * (h-4) - 2;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = vals[vals.length-1] >= vals[0] ? 'rgba(47,129,247,0.9)' : 'rgba(248,81,73,0.95)';
  ctx.stroke();
}
function computeCompositeScore(dipPct, supportPct, targetUpsidePct, weights){
  const dip = Math.max(0, -dipPct);
  const ndip = Math.min(dip/10, 1);
  const nsupport = Math.max(0, Math.min(1, (1 - (supportPct/30)) ));
  const ntarget = Math.max(0, Math.min(1, targetUpsidePct/50));
  const score = ndip*weights[0] + nsupport*weights[1] + ntarget*weights[2];
  return {score, ndip, nsupport, ntarget};
}

/* ---------------- Manual Targets (localStorage) ---------------- */
function loadManualTargets(){
  try {
    const raw = localStorage.getItem('manual_targets_v1');
    return raw ? JSON.parse(raw) : {};
  } catch(e){ return {}; }
}
function saveManualTargets(obj){ localStorage.setItem('manual_targets_v1', JSON.stringify(obj)); }

function renderManualTargetsUI(){
  const container = $('manualTargetsUI');
  container.innerHTML = '';
  const header = document.createElement('div');
  header.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Manual Price Targets (optional)</div>
    <div class="small-muted" style="margin-bottom:8px">Enter target price per ticker (used when server target absent)</div>`;
  container.appendChild(header);
  const list = document.createElement('div');
  const targets = loadManualTargets();
  CONFIG.TICKERS.forEach(t=>{
    const row = document.createElement('div');
    row.className = 'manual-target-row';
    row.innerHTML = `<div style="width:70px">${t.symbol}</div>
      <input data-symbol="${t.symbol}" class="input manual-target-input" type="number" placeholder="target ($)" value="${targets[t.symbol] || ''}">`;
    list.appendChild(row);
  });
  container.appendChild(list);
  const buttons = document.createElement('div');
  buttons.style.display = 'flex';
  buttons.style.gap = '8px';
  buttons.style.marginTop = '8px';
  buttons.innerHTML = `<button id="saveTargetsBtn" class="btn">Save Targets</button><button id="clearTargetsBtn" class="btn">Clear Targets</button>`;
  container.appendChild(buttons);

  document.getElementById('saveTargetsBtn').addEventListener('click', ()=>{
    const inputs = document.querySelectorAll('.manual-target-input');
    const obj = {};
    inputs.forEach(inp=>{
      const s = inp.dataset.symbol;
      const v = inp.value ? Number(inp.value) : null;
      if(v) obj[s] = v;
    });
    saveManualTargets(obj);
    alert('Manual targets saved');
  });
  document.getElementById('clearTargetsBtn').addEventListener('click', ()=>{
    saveManualTargets({});
    renderManualTargetsUI();
    alert('Cleared manual targets');
  });
}

/* ---------------- Proxy fetch & render ---------------- */
async function loadFromProxy(){
  const proxy = $('proxyInput').value.trim() || CONFIG.PROXY_BASE;
  const symbols = CONFIG.TICKERS.map(t=>t.symbol).join(',');
  const url = `${proxy}/api/watch?symbols=${symbols}`;
  statusEl.textContent = 'Fetching aggregated data from proxy...';
  try {
    const r = await fetch(url);
    const json = await r.json();
    clearTable();
    const rows = json.results || [];
    const results = [];
    rows.forEach((item, i) => {
      const t = CONFIG.TICKERS[i] || {symbol: item.symbol, name: item.symbol};
      const tr = createRow(i+1, t);
      // quote
      if(item.quote){
        const q = item.quote;
        const price = q.c;
        const change = q.d;
        const changePct = q.dp;
        tr.children[3].textContent = price != null ? price.toFixed(2) : '-';
        tr.children[4].textContent = change != null ? change.toFixed(2) : '-';
        tr.children[5].textContent = (changePct!=null? (changePct>0? '+':'') + changePct.toFixed(2)+'%' : '-');
      } else {
        tr.children[3].textContent = 'ERR';
      }

      // candles -> build closes (oldest->newest)
      let closes = null;
      if(item.candles && item.candles.s === 'ok' && Array.isArray(item.candles.c)){
        closes = item.candles.t.map((ts, idx) => ({ d: new Date(ts*1000).toISOString().slice(0,10), close: item.candles.c[idx] }));
        tr.children[6].textContent = pct(percentChangeFromHistory(closes,21));
        tr.children[7].textContent = pct(percentChangeFromHistory(closes,63));
        tr.children[8].textContent = pct(percentChangeFromHistory(closes,126));
        const sp = supportProximity(closes,30);
        tr.children[9].textContent = sp==null? '-' : fmt(sp,2)+'%';
        sparklineDraw(tr.querySelector('canvas'), closes);
      } else {
        tr.children[6].textContent = '-';
        tr.children[7].textContent = '-';
        tr.children[8].textContent = '-';
        tr.children[9].textContent = '-';
      }

      // target -> use server target if present, otherwise manual target
      const manual = loadManualTargets();
      const serverTarget = item.target;
      const manualVal = manual[item.symbol];
      const price = item.quote && (item.quote.c || item.quote.price) ? (item.quote.c || item.quote.price) : null;
      if(serverTarget){
        const upside = price ? ((Number(serverTarget) - price) / price) * 100 : null;
        tr.children[10].textContent = upside != null ? Number(upside).toFixed(2) + '%' : '-';
        tr.dataset.usedTarget = 'server';
      } else if(manualVal){
        const upside = price ? ((Number(manualVal) - price) / price) * 100 : null;
        tr.children[10].textContent = upside != null ? Number(upside).toFixed(2) + '%' : '-';
        tr.dataset.usedTarget = 'manual';
      } else {
        tr.children[10].textContent = '-';
        tr.dataset.usedTarget = '';
      }

      // compute simple rank: using change% as dip proxy and target upside numeric
      const changePct = item.quote ? (item.quote.dp || 0) : 0;
      const supportPct = (item.candles && item.candles.s === 'ok') ? supportProximity(closes,30) : 0;
      const targetUpside = (item.target != null) ? (((item.target) - price)/price)*100 : (manual[item.symbol]?((manual[item.symbol]-price)/price)*100:0);
      const comp = computeCompositeScore(changePct, supportPct || 0, targetUpside || 0, CONFIG.WEIGHTS);
      tr.children[11].innerHTML = `<span class="rank-badge">${(comp.score*100).toFixed(0)}</span>`;

      tr.children[13].textContent = item.quote && item.quote.t ? new Date(item.quote.t*1000).toISOString().slice(0,10) : new Date().toISOString().slice(0,10);

      results.push({ symbol: t.symbol, score: comp.score, changePct, supportPct, targetUpside });
    });

    // determine top pick
    results.sort((a,b)=>b.score - a.score);
    if(results.length>0){
      const top = results[0];
      $('nextSymbol').textContent = top.symbol;
      $('nextReason').textContent = 'Top ranked';
      $('nextScore').textContent = (top.score*100).toFixed(1);
      $('nextDip').textContent = (top.changePct||0).toFixed(2)+'%';
      $('nextUpside').textContent = top.targetUpside? top.targetUpside.toFixed(2)+'%':'-';
      $('nextBadge').textContent = 'Top Pick';
    } else {
      $('nextSymbol').textContent = '-';
      $('nextBadge').textContent = '-';
    }

    statusEl.textContent = 'Loaded from proxy';
  } catch (err){
    console.error(err);
    statusEl.textContent = 'Proxy fetch error: ' + (err.message || err);
  }
}

/* ---------------- DCA Calculator ---------------- */
$('calcBtn').addEventListener('click', ()=>{
  const portfolio = Number($('inpPortfolio').value) || 0;
  const capital = Number($('inpCapital').value) || portfolio;
  const entry = Number($('inpEntry').value) || 0;
  const allocs = $('inpAlloc').value.split(',').map(x=>Number(x.trim())||0);
  const triggers = $('inpTriggers').value.split(',').map(x=>Number(x.trim())||0);
  const slippage = Number($('inpSlippage').value)||0;
  const totalAlloc = allocs.reduce((s,a)=>s+a,0) || 100;
  const norm = allocs.map(a=>a*100/totalAlloc);
  const initialAmt = capital * (norm[0]/100);
  const dca1Amt = capital * (norm[1]/100);
  const dca2Amt = capital * (norm[2]/100);
  const initialShares = initialAmt / (entry + slippage);
  const dca1Price = entry*(1 - (triggers[0]||0)/100);
  const dca2Price = entry*(1 - (triggers[1]||0)/100);
  const dca1Shares = dca1Amt / (dca1Price + slippage);
  const dca2Shares = dca2Amt / (dca2Price + slippage);
  const totalInvest = initialAmt + dca1Amt + dca2Amt;
  const totalShares = initialShares + dca1Shares + dca2Shares;
  const avgCost = totalShares>0 ? totalInvest/totalShares : 0;
  const targetExit = avgCost*(1 + 0.05);
  const grossProceeds = totalShares * targetExit;
  const profit = grossProceeds - totalInvest;
  $('calcResults').innerHTML = `
    <div class="kv"><div class="small-muted">Initial amt</div><div>$${fmt(initialAmt,2)}</div></div>
    <div class="kv"><div class="small-muted">DCA1 amt</div><div>$${fmt(dca1Amt,2)}</div></div>
    <div class="kv"><div class="small-muted">DCA2 amt</div><div>$${fmt(dca2Amt,2)}</div></div>
    <div class="kv"><div class="small-muted">Total invested</div><div>$${fmt(totalInvest,2)}</div></div>
    <div class="kv"><div class="small-muted">Avg cost</div><div>$${fmt(avgCost,4)}</div></div>
    <div class="kv"><div class="small-muted">Target exit (+5%)</div><div>$${fmt(targetExit,4)}</div></div>
    <div class="kv"><div class="small-muted">Gross proceeds</div><div>$${fmt(grossProceeds,2)}</div></div>
    <div class="kv"><div class="small-muted">Expected profit</div><div>$${fmt(profit,2)}</div></div>
  `;
});
$('copyCalc').addEventListener('click', ()=>{
  const txt = $('calcResults').innerText || 'No results';
  navigator.clipboard?.writeText(txt).then(()=>alert('Copied summary to clipboard'));
});

/* ---------------- Settings ---------------- */
$('saveSettings').addEventListener('click', ()=>{
  localStorage.setItem('proxy_base', $('proxyInput').value.trim());
  localStorage.setItem('delay', $('delayInput').value);
  localStorage.setItem('weights', $('weightsInput').value);
  alert('Settings saved locally. Click Refresh now to apply.');
});
$('resetBtn').addEventListener('click', ()=>{ clearTable(); statusEl.textContent='Reset'; });

$('refreshBtn').addEventListener('click', ()=> { loadFromProxy(); });

/* theme toggle */
let light = false;
$('themeToggle').addEventListener('click', ()=>{
  light = !light;
  if(light){
    document.documentElement.style.setProperty('--bg','#f7f9fb');
    document.documentElement.style.setProperty('--card','#ffffff');
    document.documentElement.style.setProperty('--muted','#596a73');
    document.documentElement.style.setProperty('--text','#0b1720');
    document.documentElement.style.setProperty('--accent','#2f81f7');
    $('themeToggle').textContent = 'Toggle Dark';
  } else {
    document.documentElement.style.removeProperty('--bg');
    document.documentElement.style.removeProperty('--card');
    document.documentElement.style.removeProperty('--muted');
    document.documentElement.style.removeProperty('--text');
    $('themeToggle').textContent = 'Toggle Light';
  }
});

/* ---------------- Init ---------------- */
window.addEventListener('load', ()=>{
  const savedProxy = localStorage.getItem('proxy_base');
  if(savedProxy) $('proxyInput').value = savedProxy;
  const savedDelay = localStorage.getItem('delay');
  if(savedDelay) $('delayInput').value = savedDelay;
  const savedW = localStorage.getItem('weights');
  if(savedW) $('weightsInput').value = savedW;

  renderManualTargetsUI();

  // initial load
  setTimeout(()=>loadFromProxy(), 300);
});
</script>
</body>
</html>
